---
- include_vars: "{{ role_path }}/defaults/{{ ansible_os_family | lower }}.yml"

- include_vars: "{{ role_path }}/defaults/unix.yml"

- name: Run user setup tasks
  include_tasks: "{{ role_path }}/tasks/unix/add-jenkins-user.yml"

- name: Write labels to file
  become: true
  template:
    src: "{{ role_path }}/files/labels.txt.j2"
    dest: "{{ jenkins_swarm_labels_file }}"
    owner: "{{ jenkins_config_owner }}"
    group: "{{ jenkins_config_group }}"

- name: Set fact for get_url Python interpreter
  set_fact:
    swarm_client_get_url_python: "python"

# Older versions of macOS can have problems downloading from HTTPS websites thanks to
# outdated OpenSSL versions. As a workaround, we force python3 for this task.
# See: https://github.com/ansible/ansible/issues/33417#issuecomment-350547975
- name: Determine if get_url requires python3
  set_fact:
    swarm_client_get_url_python: "/usr/local/bin/python3"
  when: >
    ansible_os_family == "Darwin" and
    ansible_distribution_version is version_compare('10.13', '<')

- name: Download Swarm Client JAR
  become: true
  get_url:
    url: "https://repo.jenkins-ci.org/releases/org/jenkins-ci/plugins/swarm-client\
      /{{ jenkins_swarm_client_version }}\
      /swarm-client-{{ jenkins_swarm_client_version }}.jar"
    dest: "{{ jenkins_swarm_jar_path }}"
    owner: "{{ jenkins_config_owner }}"
    group: "{{ jenkins_config_group }}"
  vars:
    ansible_python_interpreter: "{{ swarm_client_get_url_python }}"

- name: Copy logging properties file
  become: true
  copy:
    src: "{{ role_path }}/files/logging.properties"
    dest: "{{ jenkins_swarm_logging_properties }}"
    owner: "{{ jenkins_config_owner }}"
    group: "{{ jenkins_config_group }}"
