---
- name: Include platform-specific defaults
  ansible.builtin.include_vars: "{{ role_path }}/vars/{{ ansible_os_family | lower }}.yml"

- name: Include unix-specific defaults
  ansible.builtin.include_vars: "{{ role_path }}/vars/unix.yml"

- name: Read service PID file
  ansible.builtin.slurp:
    src: "{{ jenkins_swarm_pid_file }}"
  failed_when: false
  register: service_pid_file

- name: Check if service is running
  ansible.builtin.command: "ps -p {{ service_pid_file.content | b64decode }}"
  changed_when: false
  register: swarm_client_running
  failed_when: false
  when: service_pid_file.content is defined

- name: Initialize should_start_swarm_client fact
  ansible.builtin.set_fact:
    should_start_swarm_client: >
      service_pid_file.content is not defined or swarm_client_running.rc != 0

- name: Start launchctl service
  when: should_start_swarm_client
  block:
    - name: Get current UID
      ansible.builtin.command: "id -u"
      changed_when: false
      register: uid

    - name: Get list of disabled services
      ansible.builtin.command: "launchctl print-disabled gui/{{ uid.stdout }}"
      changed_when: false
      register: disabled_services

    - name: Enable launchctl service
      ansible.builtin.command: >
        launchctl enable gui/{{ uid.stdout }}/{{ jenkins_swarm_client_ident }}
      when: jenkins_swarm_client_disabled in disabled_services.stdout_lines

    # TODO: Remove this suppression when ansible-lint learns to parse block conditions
    # See: https://github.com/ansible/ansible-lint/issues/1894
    - name: Start launchctl service  # noqa no-changed-when
      ansible.builtin.command: >
        launchctl bootstrap gui/{{ uid.stdout }} {{ jenkins_swarm_daemon_plist }}

    - name: Read PID file
      ansible.builtin.slurp:
        src: "{{ jenkins_swarm_pid_file }}"
      register: service_pid_file
      until: service_pid_file is succeeded
      delay: 1
      retries: 10

    - name: Assert that service is running
      ansible.builtin.command: "ps -p {{ service_pid_file.content | b64decode }}"
      changed_when: false
